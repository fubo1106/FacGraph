#include "stdafx2.h"
#include "image_kit.h"



void image_kit::ik_rotate(	const Mat& img_in32F,
							double theta, 
							bool bComplete/*=1*/, 
							IK_METHOD_INTERP method /*= IK_BILINEAR*/, 
							OUT Mat& img_out32F/*=Mat()*/ )
{
	theta*=-1.0;

	//std::cout<< img_in32F.depth()<<std::endl;
	CV_Assert(img_in32F.depth() == 5);

	int x_rotate, y_rotate;
	int x_min = 10000000, x_max = -1000000, y_min = 1000000, y_max = -1000000;

	ik_rotate_coordinate(0, 0, theta, x_rotate, y_rotate);
	
	x_min = min(x_min,x_rotate);
	x_max = max(x_max,x_rotate);
	y_min = min(y_min,y_rotate);
	y_max = max(y_max,y_rotate);

	ik_rotate_coordinate(0, img_in32F.rows, theta, x_rotate, y_rotate);

	x_min = min(x_min,x_rotate);
	x_max = max(x_max,x_rotate);
	y_min = min(y_min,y_rotate);
	y_max = max(y_max,y_rotate);

	ik_rotate_coordinate(img_in32F.cols, 0, theta, x_rotate, y_rotate);

	x_min = min(x_min,x_rotate);
	x_max = max(x_max,x_rotate);
	y_min = min(y_min,y_rotate);
	y_max = max(y_max,y_rotate);

	ik_rotate_coordinate(img_in32F.cols, img_in32F.rows ,theta, x_rotate, y_rotate);

	x_min = min(x_min,x_rotate);
	x_max = max(x_max,x_rotate);
	y_min = min(y_min,y_rotate);
	y_max = max(y_max,y_rotate);

	int row = y_max-y_min;
	int col = x_max-x_min;


	vector<Mat> img_channels, out_img_channels;
	split(img_in32F , img_channels);
	
	for(int c= 0 ; c<img_channels.size() ; ++c)
	{
		Mat in_per_channel = img_channels[c];
		Mat out_per_channel =  Mat::zeros(row, col, CV_32FC1);

		for(int y = 0; y<row ; ++y)
		{
			for(int x=0; x<col; ++x)
			{
				float u,v;
				if( bComplete == true )
				{
					u = (x+x_min)*cos(theta)+(y+y_min)*sin(theta);
					v = (y+y_min)*cos(theta)-(x+x_min)*sin(theta);
				}
				else
				{
					u = (x)*cos(theta)+(y)*sin(theta);
					v = (y)*cos(theta)-(x)*sin(theta);
				}
				if(method == IK_NEAREST)
				{
					 int iu = int(u), iv = int(v);
					 if( iu>=0 && iu< img_in32F.cols && iv>=0 && iv < img_in32F.rows)
						 out_per_channel.at<float>(y,x) = in_per_channel.at<float>(iv,iu);
				}
				else if( method == IK_BILINEAR)
				{
					int x1 = int(u), x2 = x1+1, y1=int(v), y2=y1+1;
					if( x1>=0 && x2<img_in32F.cols && y1>=0 && y2<img_in32F.rows )
						out_per_channel.at<float>(y,x) = ik_bilinearInterp(in_per_channel, u, v);
				}

			}
		}
		out_img_channels.push_back(out_per_channel);
	}
	merge(out_img_channels, img_out32F);
}

void image_kit::ik_grad( const Mat& img_in32FC3, OUT Mat& u, OUT Mat &v, OUT Mat &mag/*=Mat()*/, OUT Mat &ori/*=Mat()*/)
{
	  Mat img_gray;
	  cvtColor(img_in32FC3, img_gray, CV_BGR2GRAY);
	  u = Mat::zeros(Size(img_gray.cols, img_gray.rows),CV_32FC1);
	  v = Mat::zeros(Size(img_gray.cols, img_gray.rows),CV_32FC1);
	  for(int y=0; y<img_gray.rows;++y)
	  {
		  const float* img_gray_ptr = img_gray.ptr<float>(y);
		  float* u_ptr = u.ptr<float>(y);
		  float* v_ptr = v.ptr<float>(y);
		  for(int x=0;x<img_gray.cols;++x)
		  {
			  if(y<img_gray.rows-1)
				  v_ptr[x] = img_gray_ptr[x+img_gray.cols] - img_gray_ptr[x];
			  if(x<img_gray.cols-1)
				  u_ptr[x] = img_gray_ptr[x+1] - img_gray_ptr[x];
		  }
	  }
	  mag = Mat::zeros(Size(img_gray.cols, img_gray.rows),CV_32FC1);
	  ori = Mat::zeros(Size(img_gray.cols, img_gray.rows),CV_32FC1);
	  for(int y = 0; y < mag.rows; ++y)
	  {
		  const float* u_ptr = u.ptr<float>(y);
		  const float* v_ptr = v.ptr<float>(y);
		  float * mag_ptr = mag.ptr<float>(y);
		  float * ori_ptr = ori.ptr<float>(y);
		  for (int x = 0; x < mag.cols; ++x)
		  {
			  mag_ptr[x] = std::sqrt(u_ptr[x]*u_ptr[x]+v_ptr[x]*v_ptr[x]);
			  ori_ptr[x] = atan2(v_ptr[x],u_ptr[x]);
		  }
	  }

}

void image_kit::ik_div( const Mat& img_in32FC3, OUT Mat& div )
{
	Mat u,v;
	ik_grad(img_in32FC3, u, v);
	for(int y=1; y<u.rows; ++y)
	{
		const float* u_ptr = u.ptr<float>(y);
		const float* v_ptr = v.ptr<float>(y);
		float * div_ptr = div.ptr<float>(y);
		for(int x=1; x<u.cols; ++x)
			 div_ptr[x] = u_ptr[x] - u_ptr[x-1] + v_ptr[x] - v_ptr[x-u.cols];
	}

}

void image_kit::ik_resizeFixedLong( const Mat & img_in, Mat & img_out, double length, int method/* =1*/)
{
	 float row_in = 1.f*img_in.rows;
	 float col_in = 1.f*img_in.cols;
	 Size dsize;
	 if( row_in >= col_in)
	 {
		 dsize.height = int(length);
		 dsize.width = int(length * col_in / row_in) ;
	 }
	 else
	 {
		 dsize.width = int(length);
		 dsize.height = int(length * row_in / col_in) ;
	 }
	 cv::resize(img_in, img_out, dsize);
}																														

void image_kit::ik_resizeFixedShort( const Mat & img_in, Mat & img_out, double width, int method/* =1*/)
{
	float row_in = 1.f*img_in.rows;
	float col_in = 1.f*img_in.cols;
	Size dsize;
	if( row_in < col_in)
	{
		dsize.height = int( width);
		dsize.width = int( width * col_in / row_in) ;
	}
	else
	{
		dsize.width = int( width);
		dsize.height = int(width * row_in / col_in) ;
	}
	cv::resize(img_in, img_out, dsize);
}

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































